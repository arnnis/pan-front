{"version":3,"sources":["../src/getCurrencyPrice.ts","../src/types/api.ts","../src/types/orderType.ts","../src/orderPriceApiParsers.ts","../src/getPoolType.ts","../src/getTradeType.ts"],"names":["ResponseType","OrderType","TradeType"],"mappings":"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","sourcesContent":["import { ChainId, isTestnetChainId } from '@pancakeswap/chains'\n\nimport { Address } from './types/common'\n\nconst WALLET_API = 'https://wallet-api.pancakeswap.com/v1/prices/list/'\n\nexport const zeroAddress = '0x0000000000000000000000000000000000000000' as const\n\ntype TokenUsdPrice = {\n  address: Address\n  priceUSD: number\n}\n\n// duck typing for native currency, token, token info\nexport type CurrencyParams =\n  | {\n      chainId: ChainId\n      address: Address\n      isNative?: false\n    }\n  | {\n      chainId: ChainId\n      isNative: true\n    }\n\nexport type CurrencyKey = `${number}:${string}`\n\nexport type CurrencyUsdResult = Record<CurrencyKey, number>\n\nexport function getCurrencyKey(currencyParams?: CurrencyParams): CurrencyKey | undefined {\n  if (!currencyParams) {\n    return undefined\n  }\n\n  if ('isNative' in currencyParams && currencyParams.isNative === true) {\n    return `${currencyParams.chainId}:${zeroAddress}`\n  }\n  const { chainId, address } = currencyParams\n  return `${chainId}:${address.toLowerCase()}`\n}\n\nexport function getCurrencyListKey(currencyListParams?: CurrencyParams[]): string | undefined {\n  if (!currencyListParams) {\n    return undefined\n  }\n\n  const currencyKeys = currencyListParams.map(getCurrencyKey).filter((key): key is CurrencyKey => !!key)\n\n  const uniqueKeys = [...new Set(currencyKeys)]\n\n  return uniqueKeys.join(',')\n}\n\nfunction getRequestUrl(params?: CurrencyParams | CurrencyParams[]): string | undefined {\n  if (!params) {\n    return undefined\n  }\n  const infoList = Array.isArray(params) ? params : [params]\n  const key = getCurrencyListKey(infoList.filter((c) => !isTestnetChainId(c.chainId)))\n  if (!key) {\n    return undefined\n  }\n  const encodedKey = encodeURIComponent(key)\n  return `${WALLET_API}${encodedKey}`\n}\n\nexport async function getCurrencyUsdPrice(currencyParams?: CurrencyParams, options?: RequestInit) {\n  if (!currencyParams || isTestnetChainId(currencyParams.chainId)) {\n    return 0\n  }\n\n  const prices = await getCurrencyListUsdPrice([currencyParams], options)\n  const key = getCurrencyKey(currencyParams)\n  return (key && prices[key]) ?? 0\n}\n\nexport async function getCurrencyListUsdPrice(\n  currencyListParams?: CurrencyParams[],\n  options?: RequestInit,\n): Promise<CurrencyUsdResult> {\n  const requestUrl = getRequestUrl(currencyListParams)\n  if (!requestUrl || !currencyListParams) {\n    throw new Error(`Invalid request for currency prices, request url: ${requestUrl}`)\n  }\n  const res = await fetch(requestUrl, options)\n  const data = await res.json()\n  return data\n}\n\nexport async function getTokenPrices(\n  chainId: ChainId,\n  addresses: Address[],\n  options?: RequestInit,\n): Promise<TokenUsdPrice[]> {\n  const requestParams: CurrencyParams[] = addresses.map((address) => ({\n    address,\n    chainId,\n  }))\n  const prices = await getCurrencyListUsdPrice(requestParams, options)\n  return addresses.map((address) => {\n    const key = getCurrencyKey({\n      address,\n      chainId,\n    })\n    const priceUSD = (key && prices[key]) ?? 0\n    return { address, priceUSD }\n  })\n}\n\nexport async function getNativeTokenPrices(chainIds: ChainId[], options?: RequestInit): Promise<Map<ChainId, number>> {\n  const requestParams: CurrencyParams[] = chainIds.map((chainId) => ({\n    isNative: true,\n    chainId,\n  }))\n  const prices = await getCurrencyListUsdPrice(requestParams, options)\n  return chainIds.reduce((acc, chainId) => {\n    const key = getCurrencyKey({\n      chainId,\n      isNative: true,\n    })\n    acc.set(chainId, (key && prices[key]) ?? 0)\n    return acc\n  }, new Map<ChainId, number>())\n}\n","import { ChainId } from '@pancakeswap/chains'\n\nimport { AMMOrder, AMMRequestConfig, TradeTypeKey } from './amm'\nimport { Order } from './order'\nimport { XRequestConfig } from './pcsx'\n\nexport enum ResponseType {\n  PRICE_RESPONSE = 'PRICE_RESPONSE',\n  MM_PRICE_RESPONSE = 'MM_PRICE_RESPONSE',\n  DUTCH_LIMIT_RESPONSE = 'DUTCH_LIMIT_RESPONSE',\n  AMM_PRICE_RESPONSE = 'AMM_PRICE_RESPONSE',\n  ERROR = 'ERROR',\n}\n\nexport type ErrorResponse = {\n  messageType: ResponseType.ERROR\n  message: {\n    error: string\n    causes?: unknown\n  }\n}\n\nexport type RequestConfig = AMMRequestConfig | XRequestConfig\n\nexport type Request = {\n  type: TradeTypeKey\n  amount: string\n  tokenInChainId: ChainId\n  tokenIn: string\n  tokenOutChainId: ChainId\n  tokenOut: string\n  configs: RequestConfig[]\n  slippageTolerance?: string\n}\n\nexport type PriceResponse = {\n  messageType: ResponseType.PRICE_RESPONSE\n  message: {\n    bestOrder: Order\n    allPossibleOrders: Order[]\n  }\n}\n\nexport type AMMPriceResponse = {\n  messageType: ResponseType.AMM_PRICE_RESPONSE\n  message: AMMOrder\n}\n","export enum OrderType {\n  DUTCH_LIMIT = 'DUTCH_LIMIT',\n  PCS_CLASSIC = 'PCS_CLASSIC',\n}\n","import { ChainId } from '@pancakeswap/chains'\nimport { ExclusiveDutchOrder, createExclusiveDutchOrderTrade } from '@pancakeswap/pcsx-sdk'\nimport { PoolType, V4Router } from '@pancakeswap/smart-router'\nimport { Currency, CurrencyAmount, Percent, TradeType, type BigintIsh } from '@pancakeswap/swap-sdk-core'\nimport { zeroAddress } from './getCurrencyPrice'\nimport { getPoolTypeKey } from './getPoolType'\nimport { getTradeTypeKey } from './getTradeType'\nimport {\n  AMMOrder,\n  AMMPriceResponse,\n  ErrorResponse,\n  OrderType,\n  PriceOrder,\n  ResponseType,\n  type PriceResponse,\n  type Request,\n  type RequestConfig,\n} from './types'\n\ntype RequestInputs = {\n  amount: CurrencyAmount<Currency>\n  quoteCurrency: Currency\n  tradeType: TradeType\n  slippage?: Percent\n  amm?: {\n    poolTypes?: PoolType[]\n    maxHops?: number\n    maxSplits?: number\n    gasPriceWei?: BigintIsh\n  }\n  x?: {\n    useSyntheticQuotes?: boolean\n    swapper?: `0x${string}`\n    exclusivityOverrideBps?: number\n    startTimeBufferSecs?: number\n    auctionPeriodSecs?: number\n    deadlineBufferSecs?: number\n  }\n}\n\nconst getCurrencyIdentifier = (currency: Currency) => (currency.isNative ? zeroAddress : currency.wrapped.address)\n\nexport function getRequestBody({ amount, quoteCurrency, tradeType, amm, x, slippage }: RequestInputs): Request {\n  const [currencyIn, currencyOut] =\n    tradeType === TradeType.EXACT_INPUT ? [amount.currency, quoteCurrency] : [quoteCurrency, amount.currency]\n  const configs: RequestConfig[] = []\n\n  if (amm) {\n    configs.push({\n      protocols: amm.poolTypes?.map(getPoolTypeKey) || ['V2', 'V3', 'STABLE'],\n      routingType: OrderType.PCS_CLASSIC,\n      gasPriceWei: amm.gasPriceWei?.toString(),\n      maxHops: amm.maxHops,\n      maxSplits: amm.maxSplits,\n    })\n  }\n\n  if (x) {\n    configs.push({\n      routingType: OrderType.DUTCH_LIMIT,\n      ...x,\n    })\n  }\n\n  return {\n    amount: amount.quotient.toString(),\n    type: getTradeTypeKey(tradeType),\n    tokenInChainId: currencyIn.chainId,\n    tokenOutChainId: currencyOut.chainId,\n    slippageTolerance: slippage?.toFixed(2),\n    tokenIn: getCurrencyIdentifier(currencyIn),\n    tokenOut: getCurrencyIdentifier(currencyOut),\n    configs,\n  }\n}\n\nexport function parseQuoteResponse<\n  input extends Currency,\n  output extends Currency,\n  tradeType extends TradeType = TradeType,\n>(\n  res: PriceResponse | ErrorResponse,\n  {\n    chainId,\n    currencyOut,\n    currencyIn,\n    tradeType,\n  }: {\n    chainId: ChainId\n    currencyIn: input\n    currencyOut: output\n    tradeType: TradeType\n  },\n): PriceOrder<input, output, tradeType> {\n  if (res.messageType === ResponseType.ERROR) {\n    throw new Error(res.message.error)\n  }\n\n  const { bestOrder, allPossibleOrders } = res.message\n\n  if (bestOrder.type === OrderType.PCS_CLASSIC) {\n    return {\n      type: OrderType.PCS_CLASSIC,\n      trade: V4Router.Transformer.parseTrade(chainId, bestOrder.order),\n    }\n  }\n  if (bestOrder.type === OrderType.DUTCH_LIMIT) {\n    const order = ExclusiveDutchOrder.fromJSON(bestOrder.order.orderInfo, chainId)\n    const otherAmmTrade = allPossibleOrders.find((o) => o.type === OrderType.PCS_CLASSIC)\n\n    return {\n      type: OrderType.DUTCH_LIMIT,\n      ammTrade: otherAmmTrade ? V4Router.Transformer.parseTrade(chainId, otherAmmTrade.order as AMMOrder) : undefined,\n      trade: createExclusiveDutchOrderTrade({\n        currencyIn,\n        currenciesOut: [currencyOut],\n        orderInfo: order.info,\n        tradeType,\n      }),\n    }\n  }\n\n  throw new Error(`Unknown order type`)\n}\n\nexport function parseAMMPriceResponse(\n  chainId: ChainId,\n  res: AMMPriceResponse,\n): V4Router.V4TradeWithoutGraph<TradeType> & { gasUseEstimateUSD: number } {\n  const {\n    message: { gasUseEstimateUSD, ...rest },\n  } = res\n  const trade = V4Router.Transformer.parseTrade(chainId, rest)\n\n  return {\n    ...trade,\n    gasUseEstimateUSD: Number(gasUseEstimateUSD),\n  }\n}\n","import { PoolType } from '@pancakeswap/smart-router'\n\nimport type { PoolTypeKey } from './types'\n\nexport function getPoolType(type: string): PoolType | undefined {\n  return PoolType[type as PoolTypeKey]\n}\n\nexport function getPoolTypeKey(poolType: PoolType): PoolTypeKey {\n  for (const [key, value] of Object.entries(PoolType)) {\n    if (value === poolType) {\n      return key as PoolTypeKey\n    }\n  }\n  throw new Error(`Invalid pool type: ${poolType}`)\n}\n","import { TradeType } from '@pancakeswap/swap-sdk-core'\n\nimport type { TradeTypeKey } from './types'\n\nexport function getTradeTypeByKey(type: string): TradeType | undefined {\n  return TradeType[type as keyof typeof TradeType]\n}\n\nexport function getTradeTypeKey(tradeType: TradeType): TradeTypeKey {\n  for (const [key, value] of Object.entries(TradeType)) {\n    if (value === tradeType) {\n      return key as TradeTypeKey\n    }\n  }\n  throw new Error(`Invalid trade type: ${tradeType}`)\n}\n"]}